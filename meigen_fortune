#!/bin/python3

import os
import random
import re
import sys

import yaml

from scripts.lib import args

MEIGEN_TEMPLATE = {
    "content": {
        False: "\033[38;5;229;1m   {0}\033[m",
        True: "{0}"
    },
    "prop": {
        False: "\033[38;5;250m               --- {0} (#{1})\033[m",
        True: "               --- {0} (#{1})"
    }
}

DEFAULT_FILE_PATH = \
    os.environ["BLINTOOL_DIRECTORY"] + \
    "/local_data/meigen.yaml"

argument: args.ArgParser = args.ArgParser(
    name="meigen_fortune",
    args=[
        args.FlagArgs(
            "no-color", "Show meigen without color.",
            dest="color"
        ),
        args.OptionContentArgs(
            "file", "The file to read meigen.",
        ),
        args.PositionalArgs(
            "id", "The ID of the meigen you want to see.",
            required=False
        ),
    ]
)

if __name__ == '__main__':
    file_path = argument.get_or("file", DEFAULT_FILE_PATH)
    if not os.path.exists(file_path):
        print("[!] Meigen Database File not found: {0}".format(file_path))
        sys.exit(1)

    with open(argument.get_or("file", DEFAULT_FILE_PATH)) as f:
        meigen_db = yaml.load(f.read(), yaml.FullLoader)

    meigen_id_list = list(map(lambda x: x["id"], meigen_db))
    raw_meigen_id = argument.get_or(
        "id", str(random.choice(meigen_id_list))
    )

    if re.match("-?[0-9]+", raw_meigen_id) is None:
        print("[!] The Meigen ID seems not valid number.")
        sys.exit(1)

    if int(raw_meigen_id) not in meigen_id_list:
        print("[!] Meigen #{0} not found.".format(raw_meigen_id))
        sys.exit(1)

    meigen = list(
        filter(lambda x: x["id"] == int(raw_meigen_id), meigen_db)
    )[0]

    print(MEIGEN_TEMPLATE["content"][argument.get_or("color", False)].format(
        meigen["content"].replace("\n", "\n   ")
    ))
    print(MEIGEN_TEMPLATE["prop"][argument.get_or("color", False)].format(
        meigen["author"], meigen["id"]
    ))
